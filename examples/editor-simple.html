<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Minimal SWT Editor</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="../dist/swt.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    button { padding: 8px 16px; margin: 5px; cursor: pointer; }
    #controls { padding: 10px; background: #f0f0f0; }
    #preview { height: calc(100vh - 60px); background: #000; }
  </style>
</head>
<body>
  <div id="controls">
    <input type="file" id="imageUpload" accept="image/*">
    <button id="exportBtn">Export JSON</button>
    <span id="status">No scene loaded</span>
  </div>
  <div id="preview"></div>

  <script>
    let scene = { id: 'scene1', name: 'My Scene', imageUrl: '', hotspots: [] };
    let placementMode = false;

    document.getElementById('imageUpload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        scene.imageUrl = e.target.result;
        scene.name = file.name;
        loadPreview();
        document.getElementById('status').textContent = `Loaded: ${file.name}`;
      };
      reader.readAsDataURL(file);
    });

    function loadPreview() {
      document.getElementById('preview').innerHTML = `
        <a-scene embedded style="width: 100%; height: 100%;">
          <a-sky src="${scene.imageUrl}"></a-sky>
          <a-camera><a-cursor></a-cursor></a-camera>
          ${scene.hotspots.map((h, i) => `
            <a-sphere position="${h.x} ${h.y} ${h.z}" radius="0.3" color="#00ff00"></a-sphere>
          `).join('')}
        </a-scene>
      `;

      setTimeout(() => {
        document.querySelector('a-scene').addEventListener('click', (e) => {
          if (!placementMode || !e.detail.intersection) return;
          const p = e.detail.intersection.point;
          scene.hotspots.push({ x: p.x.toFixed(2), y: p.y.toFixed(2), z: p.z.toFixed(2) });
          loadPreview();
          document.getElementById('status').textContent = `${scene.hotspots.length} hotspot(s)`;
        });
      }, 1000);
    }

    document.getElementById('exportBtn').addEventListener('click', () => {
      const config = {
        initialScene: scene.id,
        scenes: {
          [scene.id]: {
            name: scene.name,
            panorama: scene.imageUrl,
            hotspots: scene.hotspots.map((h, i) => ({
              id: `hotspot-${i}`,
              position: { x: parseFloat(h.x), y: parseFloat(h.y), z: parseFloat(h.z) },
              action: { type: 'navigateTo', target: scene.id }
            }))
          }
        }
      };

      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tour.json';
      a.click();
    });

    // Toggle placement mode with Spacebar
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && scene.imageUrl) {
        placementMode = !placementMode;
        document.getElementById('status').textContent = placementMode 
          ? 'PLACEMENT MODE: Click preview to add hotspot' 
          : `${scene.hotspots.length} hotspot(s)`;
      }
    });
  </script>
</body>
</html>